// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt and http://www.arcgis.com/apps/webappbuilder/copyright.txt for details.
//>>built
require({cache:{"url:widgets/Visibility/templates/portal-publish.html":'\x3cdiv class\x3d"esriCTFullHeight" data-dojo-attach-point\x3d"resultsPageNode"\x3e\r\n  \x3cdiv class\x3d"esriCTFullWidth esriCTSettingHeader"\x3e\r\n    \x3cdiv class\x3d"esriCTBackButton" title\x3d"${nls.back}"\x3e\r\n      \x3cdiv class\x3d"esriCTItemLeftArrow" data-dojo-attach-point\x3d"resultsPanelBackButton" tabindex\x3d"0"\r\n        aria-label\x3d"${nls.back}" role\x3d"button"\x3e\x3c/div\x3e\r\n      \x3cdiv class\x3d"esriCTTitleDiv esriCTEllipsis" title\x3d"${nls.resultsTitle}"\x3e${nls.resultsTitle}\x3c/div\x3e\r\n    \x3c/div\x3e\r\n    \x3cdiv class\x3d"esriCTMainPageRow"\x3e\r\n      \x3c!-- esriCT Layer Name --\x3e\r\n      \x3cdiv class\x3d"esriCTFullWidth esriCTSettingRow"\x3e\r\n        \x3cdiv class\x3d"esriCTInputLabel esriCTEllipsis" title\x3d"${nls.layerName}"\x3e${nls.layerName}\x3c/div\x3e\r\n        \x3cinput aria-label\x3d"${nls.layerName}" class\x3d"esriCTHidden" style\x3d"width: 100%; margin-bottom: 8px;"\r\n          data-dojo-type\x3d"dijit/form/ValidationTextBox" data-dojo-attach-point\x3d"addLayerNameArea"\r\n          data-dojo-props\x3d"regExp:\'[a-zA-Z0-9_ -]*\', invalidMessage:\'${nls.invalidLayerName}\', missingMessage:\'${nls.missingLayerName}\'"\r\n          required\x3d"true" tabindex\x3d"0"\x3e\x3c/input\x3e\r\n        \x3cselect class\x3d"publishSelect" aria-label\x3d"${nls.layerName}" data-dojo-type\x3d"jimu/dijit/formSelect" tabindex\x3d"0"\r\n          data-dojo-attach-point\x3d"featureLayerList"\x3e\x3c/select\x3e\r\n        \x3cdiv class\x3d"esriCTCheckBoxNode" data-dojo-attach-point\x3d"checkBoxParentContainer"\x3e\x3c/div\x3e\r\n      \x3c/div\x3e\r\n      \x3c!-- Publish esriCT Button --\x3e\r\n      \x3cdiv class\x3d"esriCTPublishBtnContainer"\x3e\r\n        \x3cdiv class\x3d\'jimu-btn\' data-dojo-attach-point\x3d\'publishButton\' tabindex\x3d"0" aria-label\x3d"${nls.publishBtnLabel}"\r\n          role\x3d"button"\x3e${nls.publishBtnLabel}\x3c/div\x3e\r\n      \x3c/div\x3e\r\n\r\n      \x3c!-- Publishing Message --\x3e\r\n      \x3cdiv class\x3d"esriCTPublishMessage" data-dojo-attach-point\x3d"publishMessage"\x3e\x3c/div\x3e\r\n    \x3c/div\x3e\r\n  \x3c/div\x3e\r\n\x3c/div\x3e'}});
define("dojo/_base/declare jimu/BaseWidget dijit/_WidgetsInTemplateMixin jimu/dijit/CheckBox dojo/_base/array dojo/_base/lang dojo/json dojo/text!../templates/portal-publish.html dojo/dom-construct dojo/on dojo/dom-class dojo/dom-style jimu/utils esri/arcgis/Portal dojo/Evented ./portal-utils jimu/LayerInfos/LayerInfos esri/layers/FeatureLayer esri/graphic esri/dijit/util/busyIndicator jimu/utils dojo/keys dijit/focus dojo/query dojo/topic dijit/form/ValidationTextBox jimu/dijit/formSelect".split(" "),
function(x,y,z,A,h,a,l,B,C,g,c,D,E,F,G,k,t,u,p,H,q,m,r,v,w){return x([y,z,G],{templateString:B,baseClass:"jimu-widget-visibility-publish",publishNewLayer:null,busyIndicator:null,fieldsObj:null,postCreate:function(){String.prototype.format||(String.prototype.format=function(){var b=arguments;return this.replace(/{(\d+)}/g,function(a,e){return"undefined"!==typeof b[e]?b[e]:a})});this.fieldsObj={RegionType:{value:"",dataType:"esriFieldTypeInteger"},CenterPoint:{value:this.centerPoint,dataType:"esriFieldTypeString"},
ObservationHeight:{value:this.observerHeight,dataType:"esriFieldTypeDouble"},HeightUnit:{value:this.observerHeightDD,dataType:"esriFieldTypeString"},MinObservationDistance:{value:this.minObsRange,dataType:"esriFieldTypeDouble"},MaxObservationDistance:{value:this.maxObsRange,dataType:"esriFieldTypeDouble"},DistanceUnit:{value:this.distanceUnitDD,dataType:"esriFieldTypeString"},FOVStartAngle:{value:this.fovStartAngle,dataType:"esriFieldTypeDouble"},FOVEndAngle:{value:this.fovEndAngle,dataType:"esriFieldTypeDouble"},
AngleUnits:{value:this.angleUnits,dataType:"esriFieldTypeString"}};this.fields={RegionType:"",CenterPoint:this.centerPoint,ObservationHeight:this.observerHeight,HeightUnit:this.observerHeightDD,MinObservationDistance:this.minObsRange,MaxObservationDistance:this.maxObsRange,DistanceUnit:this.distanceUnitDD,FOVStartAngle:this.fovStartAngle,FOVEndAngle:this.fovEndAngle,AngleUnits:this.angleUnits};this.publishNewLayer=new A({checked:!1,label:this.nls.publishToNewLayer},C.create("div",{},this.checkBoxParentContainer));
this.own(g(this.publishNewLayer,"change",a.hitch(this,this._onCheckboxClicked)));this._populateSelectList(this.featureLayerList,this._layerList,!0);!this.config.hasOwnProperty("operationalLayer")||this.config.hasOwnProperty("operationalLayer")&&this.config.operationalLayer.hasOwnProperty("name")&&""===this.config.operationalLayer.name?(c.add(this.featureLayerList.domNode,"esriCTHidden"),this.publishNewLayer.setValue(!0),c.remove(this.addLayerNameArea.domNode,"esriCTHidden")):(c.remove(this.featureLayerList.domNode,
"esriCTHidden"),this.publishNewLayer.setValue(!1),c.add(this.addLayerNameArea.domNode,"esriCTHidden"));this.own(g(this.resultsPanelBackButton,"click",a.hitch(this,function(){this.emit("displayMainPageOnBack")})));this.own(g(this.resultsPanelBackButton,"keydown",a.hitch(this,function(b){b.keyCode!==m.ENTER&&b.keyCode!==m.SPACE||this.emit("displayMainPageOnBack")})));this.own(g(this.publishButton,"click",a.hitch(this,function(){if(this.publishNewLayer.checked&&!this.addLayerNameArea.isValid())this.publishMessage.innerHTML=
this.nls.missingLayerNameMessage;else{var b=this.publishNewLayer.checked?this.addLayerNameArea.value:this.featureLayerList.get("value");this.publishMessage.innerHTML="";this._initSaveToPortal(b)}})));this.own(g(this.publishButton,"keydown",a.hitch(this,function(b){if(b.keyCode===m.ENTER||b.keyCode===m.SPACE)this.publishNewLayer.checked&&!this.addLayerNameArea.isValid()?(this.publishMessage.innerHTML=this.nls.missingLayerNameMessage,this._setFirstLastFocusNodes()):(b=this.publishNewLayer.checked?this.addLayerNameArea.value:
this.featureLayerList.get("value"),this.publishMessage.innerHTML="",this._initSaveToPortal(b))})));this.own(w.subscribe("WIDGET_RESIZE",a.hitch(this,this._onWidgetResize)));this.own(g(this.featureLayerList,"change",a.hitch(this,function(){this._onWidgetResize()})))},startup:function(){this.busyIndicator=H.create({target:this.parentNode.parentNode.parentNode.parentNode,backgroundOpacity:0})},_onWidgetResize:function(){var b=v(".dijitValidationTextBoxLabel",this.featureLayerList.domNode);0<b.length&&
D.set(b[0],"width",this.publishButton.clientWidth-53+"px")},_onCheckboxClicked:function(){this.publishNewLayer.checked?(c.add(this.featureLayerList.domNode,"esriCTHidden"),c.remove(this.addLayerNameArea.domNode,"esriCTHidden"),this.addLayerNameArea.reset(),this.addLayerNameArea.focus()):(c.add(this.addLayerNameArea.domNode,"esriCTHidden"),c.remove(this.featureLayerList.domNode,"esriCTHidden"));this._addLayerToMap=this.publishNewLayer.checked},_populateSelectList:function(b,d,e){var c=[];e&&(c=h.filter(d,
function(b){return"esriGeometryPolygon"===b.geometryType},this));d=0<c.length?c:d;h.forEach(d,a.hitch(this,function(a){a.url&&"Feature Layer"===a.type&&a.capabilities.includes("Create,Delete,Query,Update,Editing")&&b.addOption({value:l.parse(a._json).name,label:E.sanitizeHTML(a.name),selected:!1,id:a.id})}));this.config.hasOwnProperty("operationalLayer")&&this.config.operationalLayer.hasOwnProperty("name")&&""!==this.config.operationalLayer.name?b.setValue(this.config.operationalLayer.name):b.setValue("")},
_initSaveToPortal:function(b){(new F.Portal(this.appConfig.portalUrl)).signIn().then(a.hitch(this,function(d){var e=d.credential.token,c=d.orgId,f=d.username;if("org_user"===d.role)this.publishMessage.innerHTML=this.nls.createService.format(this.nls.userRole),this._setFirstLastFocusNodes();else{var n=this.appConfig.portalUrl+"sharing/content/users/"+f+"/createService";k.isNameAvailable(this.appConfig.portalUrl+"sharing/rest/portals/"+c+"/isServiceNameAvailable",e,b).then(a.hitch(this,function(c){if(c.available)this.busyIndicator.show(),
k.createFeatureService(n,e,k.getFeatureServiceParams(b,this.map)).then(a.hitch(this,function(d){if(d.success){var c=d.serviceurl.replace(/rest/g,"rest/admin")+"/addToDefinition";k.addDefinitionToService(c,e,k.getLayerParams(b,this.map,this._renderer,this.nls)).then(a.hitch(this,function(c){if(c.success){c=new u(d.serviceurl+"/0?token\x3d"+e,{id:b,outFields:["*"]});c._wabProperties={itemLayerInfo:{portalUrl:this.appConfig.portalUrl,itemId:d.itemId}};this.map.addLayer(c);var f;if(c.loaded)f=t.getInstanceSync().getLayerInfoById(b),
f.enablePopup();else c.on("load",a.hitch(this,function(){f=t.getInstanceSync().getLayerInfoById(b);f.enablePopup()}));var n=[];h.forEach(this.graphics,function(b){if(void 0!==b.attributes&&b.attributes.hasOwnProperty("type")){var c=a.clone(this.fields);c.RegionType=b.attributes.type;n.push(new p(b.geometry,null,c))}},this);c.applyEdits(n,null,null).then(a.hitch(this,function(){this._reset()})).otherwise(a.hitch(this,function(){this._reset()}));this.busyIndicator.hide();this.publishMessage.innerHTML=
this.nls.successfullyPublished.format('\x3cbr /\x3e\x3ca role\x3d"link" tabindex\x3d0 aria-label\x3d"'+this.nls.successfullyPublished+'" href\x3d"'+this.appConfig.portalUrl+"home/item.html?id\x3d"+d.itemId+'" target\x3d"_blank"\x3e')+"\x3c/a\x3e";this._setFirstLastFocusNodes()}}),a.hitch(this,function(b){this.busyIndicator.hide();this.publishMessage.innerHTML=this.nls.addToDefinition.format(b.message);this._setFirstLastFocusNodes()}))}else this.busyIndicator.hide(),this.publishMessage.innerHTML=this.nls.unableToCreate.format(b),
this._setFirstLastFocusNodes()}),a.hitch(this,function(b){this.busyIndicator.hide();this.publishMessage.innerHTML=this.nls.createService.format(b.message);this._setFirstLastFocusNodes()}));else{var d=null;h.forEach(this._layerList,a.hitch(this,function(a){a._json&&l.parse(a._json).name&&l.parse(a._json).name===b&&(d=a)}));if(d){var f=new u(d.url+"/0?token\x3d"+e,{id:b,outFields:["*"]});f._wabProperties={itemLayerInfo:{portalUrl:this.appConfig.portalUrl,itemId:d.id}};f.on("load",a.hitch(this,function(b){var c=
[];h.forEach(this.graphics,function(a){if(void 0!==a.attributes&&a.attributes.hasOwnProperty("type")){var d=this._matchLayerFields(a.attributes.type,b.layer._fields);0<Object.keys(d).length?c.push(new p(a.geometry,null,d)):c.push(new p(a.geometry,null,{}))}},this);f.applyEdits(c,null,null).then(a.hitch(this,function(){this._reset()})).otherwise(a.hitch(this,function(){this._reset()}));w.publish("moveMap",!1);var e='\x3cbr /\x3e\x3ca href\x3d"'+this.appConfig.portalUrl+"home/item.html?id\x3d"+l.parse(d._json).serviceItemId+
'" target\x3d"_blank"\x3e';this.publishMessage.innerHTML=this.nls.successfullyPublished.format(e)+"\x3c/a\x3e"}))}else this.busyIndicator.hide(),this.publishMessage.innerHTML=this.nls.layerNameExists;this._setFirstLastFocusNodes()}}),a.hitch(this,function(b){this.busyIndicator.hide();this.publishMessage.innerHTML=this.nls.checkService.format(b.message);this._setFirstLastFocusNodes()}))}}),a.hitch(this,function(b){this.publishMessage.innerHTML=b.message;this._setFirstLastFocusNodes()}))},_reset:function(){this.graphicsLayer.clear();
this.graphics=[];this.graphicsLayer.refresh()},_setFirstLastFocusNodes:function(){q.initFirstFocusNode(this.parentNode,this.resultsPanelBackButton);r.focus(this.resultsPanelBackButton);q.initLastFocusNode(this.parentNode,this.publishButton);var b=v("a",this.publishMessage)[0];""!==this.publishMessage.innerHTML&&b?(q.initLastFocusNode(this.parentNode,this.publishMessage),r.focus(b)):""===this.publishMessage.innerHTML&&r.focus(this.resultsPanelBackButton)},_matchLayerFields:function(b,c){var d={},g=
Object.keys(this.fieldsObj);h.forEach(c,a.hitch(this,function(c){h.forEach(g,a.hitch(this,function(a){if(c.name.toLowerCase()===a.toLowerCase()&&(c.type===this.fieldsObj[a].dataType||"esriFieldTypeString"===c.type)){var e=this.fieldsObj[a].value;"esriFieldTypeString"===c.type&&50>c.length&&"string"===typeof this.fieldsObj[a].value&&(e=this.fieldsObj[a].value.substr(0,c.length));d[c.name]="RegionType"===a?b:e}}))}));return d}})});